{% extends 'social/base.html' %}

{% block title %}Home - InstaLite{% endblock %}

{% block content %}
<div class="posts">
    {% for post in posts %}
    <div class="post-card">
        <div class="post-header">
            <img src="{{ post.user.profile.profile_picture.url|default:'/static/default_profile.png' }}" alt="{{ post.user.username }}">
            <a href="{% url 'profile' post.user.username %}" class="username">{{ post.user.username }}</a>
            {% if post.user == request.user %}
            <div class="post-options">
                <button class="post-option-btn" onclick="togglePostOptions({{ post.id }})">
                    <i class="fas fa-ellipsis-h"></i>
                </button>
                <div class="post-options-menu" id="postOptions{{ post.id }}">
                    <form action="{% url 'delete_post' post.id %}" method="POST">
                        {% csrf_token %}
                        <button type="submit" class="delete-option" onclick="return confirm('Are you sure you want to delete this post?');">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>

        <img src="{{ post.image.url }}" alt="Post Image" class="post-image">

        <div class="post-actions">
            <button class="like-button" data-post-id="{{ post.id }}">
                <i class="fas fa-heart {% if request.user in post.likes.all %}liked{% endif %}"></i>
            </button>
            <button class="comment-button">
                <i class="fas fa-comment"></i>
            </button>
        </div>

        <div class="likes">
            {{ post.like_count }} likes
        </div>

        <div class="caption">
            <a href="{% url 'profile' post.user.username %}" class="username">{{ post.user.username }}</a>
            {{ post.caption }}
        </div>

        <div class="comments-section">
            {% for comment in post.comments.all %}
            <div class="comment">
                <a href="{% url 'profile' comment.user.username %}" class="username">{{ comment.user.username }}</a>
                {{ comment.text }}
            </div>
            {% endfor %}
        </div>

        <form method="post" action="{% url 'comment' post.id %}" class="comment-form">
            {% csrf_token %}
            <input type="text" name="comment" placeholder="Add a comment..." required>
            <button type="submit">Post</button>
        </form>
    </div>
    {% empty %}
    <div class="no-posts">
        <h3>No posts yet!</h3>
        <p>Be the first to share something.</p>
        <a href="{% url 'upload' %}" class="create-post-button">Create Post</a>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    $('.like-button').click(function(e) {
        e.preventDefault();
        const button = $(this);
        const postId = button.data('post-id');
        
        $.post(`/like/${postId}/`, {
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        })
        .done(function(response) {
            const icon = button.find('i');
            const likesCount = button.closest('.post-card').find('.likes');
            
            if (response.liked) {
                icon.addClass('liked');
            } else {
                icon.removeClass('liked');
            }
            
            likesCount.text(response.count + ' likes');
        });
    });
});

function togglePostOptions(postId) {
    const menu = document.getElementById('postOptions' + postId);
    menu.classList.toggle('show');
    
    // Close other open menus
    document.querySelectorAll('.post-options-menu.show').forEach(openMenu => {
        if (openMenu.id !== 'postOptions' + postId) {
            openMenu.classList.remove('show');
        }
    });
}

// Close menus when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.post-options')) {
        document.querySelectorAll('.post-options-menu.show').forEach(menu => {
            menu.classList.remove('show');
        });
    }
});
</script>
{% endblock %} 